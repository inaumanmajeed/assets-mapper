name: NPM Auto Deploy

on:
  push:
    branches: [main]
  workflow_run:
    workflows: ["CI/CD Pipeline"]
    branches: [main]
    types:
      - completed

jobs:
  deploy-to-npm:
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main'

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: "18"
          registry-url: "https://registry.npmjs.org"
          cache: "npm"

      - name: Configure Git
        run: |
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action Bot"

      - name: Install dependencies
        run: npm ci

      - name: Build project
        run: npm run build

      - name: Check deployment status
        id: deploy-check
        run: |
          # Get current version from package.json
          CURRENT_VERSION=$(node -p "require('./package.json').version")
          echo "current-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT

          # Check what's published on npm
          PUBLISHED_VERSION=$(npm view assets-mapper version 2>/dev/null || echo "none")
          echo "published-version=$PUBLISHED_VERSION" >> $GITHUB_OUTPUT

          # Check if we need to deploy
          if [ "$PUBLISHED_VERSION" = "none" ]; then
            echo "No version published yet, deploying $CURRENT_VERSION"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "deploy-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          elif [ "$CURRENT_VERSION" != "$PUBLISHED_VERSION" ]; then
            echo "Version changed from $PUBLISHED_VERSION to $CURRENT_VERSION"
            echo "should-deploy=true" >> $GITHUB_OUTPUT
            echo "deploy-version=$CURRENT_VERSION" >> $GITHUB_OUTPUT
          else
            # Check if we have new commits since last deployment
            LAST_COMMIT_MESSAGE=$(git log -1 --pretty=%B)
            if [[ "$LAST_COMMIT_MESSAGE" == *"[skip deploy]"* ]]; then
              echo "Skipping deployment due to [skip deploy] in commit message"
              echo "should-deploy=false" >> $GITHUB_OUTPUT
            else
              echo "Same version but new changes detected, auto-bumping patch version"
              # Auto-increment patch version
              npm version patch --no-git-tag-version
              NEW_VERSION=$(node -p "require('./package.json').version")
              echo "deploy-version=$NEW_VERSION" >> $GITHUB_OUTPUT
              echo "should-deploy=true" >> $GITHUB_OUTPUT
              echo "auto-bumped=true" >> $GITHUB_OUTPUT
            fi
          fi

      - name: Commit auto-bumped version
        if: steps.deploy-check.outputs.auto-bumped == 'true'
        run: |
          git add package.json package-lock.json
          git commit -m "chore: auto-bump version to ${{ steps.deploy-check.outputs.deploy-version }} [skip deploy]"
          git push origin main

      - name: Run pre-publish checks
        if: steps.deploy-check.outputs.should-deploy == 'true'
        run: |
          echo "ðŸ” Running pre-publish checks..."

          # Verify lib directory exists
          if [ ! -d "lib" ]; then
            echo "âŒ lib directory not found"
            exit 1
          fi

          # Verify required files exist
          if [ ! -f "lib/index.js" ] || [ ! -f "lib/generator.js" ]; then
            echo "âŒ Required lib files missing"
            exit 1
          fi

          # Test CLI functionality
          echo "ðŸ§ª Testing CLI..."
          mkdir -p temp-test-assets
          echo "test" > temp-test-assets/test.png
          node bin/assets-mapper.js --src ./temp-test-assets --out ./temp-test-output.js --public

          if [ ! -f "./temp-test-output.js" ]; then
            echo "âŒ CLI test failed - no output generated"
            exit 1
          fi

          # Verify output contains expected exports
          if ! grep -q "export const" temp-test-output.js; then
            echo "âŒ CLI test failed - no exports found"
            exit 1
          fi

          # Cleanup
          rm -rf temp-test-assets temp-test-output.js
          echo "âœ… All pre-publish checks passed"

      - name: Deploy to NPM
        if: steps.deploy-check.outputs.should-deploy == 'true'
        run: |
          echo "ðŸš€ Deploying assets-mapper@${{ steps.deploy-check.outputs.deploy-version }} to npm..."
          npm publish --access public
          echo "âœ… Successfully published to npm!"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}

      - name: Create Git Tag
        if: steps.deploy-check.outputs.should-deploy == 'true'
        run: |
          git tag v${{ steps.deploy-check.outputs.deploy-version }}
          git push origin v${{ steps.deploy-check.outputs.deploy-version }}

      - name: Post-deployment verification
        if: steps.deploy-check.outputs.should-deploy == 'true'
        run: |
          echo "ðŸ” Verifying deployment..."
          sleep 30  # Wait for npm to propagate

          # Verify package is available on npm
          DEPLOYED_VERSION=$(npm view assets-mapper version 2>/dev/null || echo "failed")
          if [ "$DEPLOYED_VERSION" = "${{ steps.deploy-check.outputs.deploy-version }}" ]; then
            echo "âœ… Deployment verified! Package is available on npm"
            echo "ðŸ“¦ NPM URL: https://www.npmjs.com/package/assets-mapper"
            echo "ðŸ·ï¸ Version: $DEPLOYED_VERSION"
          else
            echo "âš ï¸ Deployment verification failed, but this might be due to npm propagation delay"
            echo "Expected: ${{ steps.deploy-check.outputs.deploy-version }}"
            echo "Found: $DEPLOYED_VERSION"
          fi

      - name: Deployment Summary
        if: always()
        run: |
          if [ "${{ steps.deploy-check.outputs.should-deploy }}" = "true" ]; then
            echo "## ðŸš€ Deployment Summary" >> $GITHUB_STEP_SUMMARY
            echo "- **Package**: assets-mapper" >> $GITHUB_STEP_SUMMARY
            echo "- **Version**: ${{ steps.deploy-check.outputs.deploy-version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Deployed âœ…" >> $GITHUB_STEP_SUMMARY
            echo "- **NPM URL**: https://www.npmjs.com/package/assets-mapper" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "### Installation" >> $GITHUB_STEP_SUMMARY
            echo '```bash' >> $GITHUB_STEP_SUMMARY
            echo "npm install assets-mapper@${{ steps.deploy-check.outputs.deploy-version }}" >> $GITHUB_STEP_SUMMARY
            echo '```' >> $GITHUB_STEP_SUMMARY
          else
            echo "## â„¹ï¸ Deployment Summary" >> $GITHUB_STEP_SUMMARY
            echo "- **Status**: Skipped (no changes detected)" >> $GITHUB_STEP_SUMMARY
            echo "- **Current Version**: ${{ steps.deploy-check.outputs.current-version }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Published Version**: ${{ steps.deploy-check.outputs.published-version }}" >> $GITHUB_STEP_SUMMARY
          fi
